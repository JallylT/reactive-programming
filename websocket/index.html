<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Island</title>
    <style>
        :root {
            /* Couleurs mode clair - Animal Crossing */
            --bg-primary: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            --bg-secondary: #FFFACD;
            --bg-chat: rgba(255, 255, 255, 0.95);
            --bg-message: #F0F8FF;
            --bg-own-message: #E6F3E6;
            --bg-system: #FFE4E1;
            --bg-error: #FFE4E4;
            --bg-username-setup: rgba(255, 255, 255, 0.9);

            --text-primary: #2F4F4F;
            --text-secondary: #556B2F;
            --text-accent: #8B4513;
            --text-username: #4682B4;
            --text-system: #CD5C5C;
            --text-error: #DC143C;

            --border-color: #DEB887;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-primary: linear-gradient(45deg, #32CD32, #228B22);
            --button-secondary: linear-gradient(45deg, #4169E1, #1E90FF);
            --button-hover: rgba(255, 255, 255, 0.2);

            /* Mode sombre */
            --dark-bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --dark-bg-secondary: #0f3460;
            --dark-bg-chat: rgba(26, 26, 46, 0.95);
            --dark-bg-message: #2d3748;
            --dark-bg-own-message: #2d5016;
            --dark-bg-system: #4a1a1a;
            --dark-bg-error: #5a1a1a;
            --dark-bg-username-setup: rgba(26, 26, 46, 0.9);

            --dark-text-primary: #e2e8f0;
            --dark-text-secondary: #a0aec0;
            --dark-text-accent: #fbd38d;
            --dark-text-username: #63b3ed;
            --dark-text-system: #fc8181;
            --dark-text-error: #feb2b2;

            --dark-border-color: #4a5568;
            --dark-shadow-color: rgba(0, 0, 0, 0.3);
            --dark-button-primary: linear-gradient(45deg, #38a169, #2d7a3d);
            --dark-button-secondary: linear-gradient(45deg, #3182ce, #2c5282);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Trebuchet MS', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        body.dark-mode {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-chat: var(--dark-bg-chat);
            --bg-message: var(--dark-bg-message);
            --bg-own-message: var(--dark-bg-own-message);
            --bg-system: var(--dark-bg-system);
            --bg-error: var(--dark-bg-error);
            --bg-username-setup: var(--dark-bg-username-setup);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --text-accent: var(--dark-text-accent);
            --text-username: var(--dark-text-username);
            --text-system: var(--dark-text-system);
            --text-error: var(--dark-text-error);
            --border-color: var(--dark-border-color);
            --shadow-color: var(--dark-shadow-color);
            --button-primary: var(--dark-button-primary);
            --button-secondary: var(--dark-button-secondary);
        }

        /* √âl√©ments d√©coratifs Animal Crossing */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 2px, transparent 2px),
                radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.05) 3px, transparent 3px);
            background-size: 100px 100px, 150px 150px, 200px 200px;
            pointer-events: none;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .chat-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-chat);
            border-radius: 25px;
            padding: 30px;
            box-shadow:
                0 20px 40px var(--shadow-color),
                0 0 0 3px var(--border-color),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid var(--border-color);
            position: relative;
            animation: fadeInUp 0.6s ease-out;
        }

        .chat-container::before {
            content: 'üåü';
            position: absolute;
            top: -15px;
            left: 30px;
            font-size: 30px;
            animation: bounce 2s infinite;
        }

        .chat-container::after {
            content: 'üå∏';
            position: absolute;
            top: -15px;
            right: 30px;
            font-size: 25px;
            animation: bounce 2s infinite 0.5s;
        }

        h1 {
            text-align: center;
            color: var(--text-accent);
            margin-bottom: 25px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px var(--shadow-color);
            background: linear-gradient(45deg, var(--text-accent), var(--text-username));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--button-secondary);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--button-primary);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
            display: none;
        }

        .back-button.active {
            display: block;
        }

        .back-button:hover {
            transform: scale(1.1) translateX(-5px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.4);
        }

        .back-button:active {
            transform: scale(0.95);
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .status:hover::before {
            left: 100%;
        }

        .status.connected {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: var(--text-system);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .status.disconnected {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: var(--text-error);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            animation: shake 0.5s ease-in-out;
        }

        .username-setup {
            background: var(--bg-username-setup);
            border: 3px solid var(--border-color);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px var(--shadow-color);
            position: relative;
            animation: fadeInUp 0.8s ease-out;
        }

        .username-setup::before {
            content: 'üè°';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            background: var(--bg-chat);
            padding: 10px;
            border-radius: 50%;
            border: 3px solid var(--border-color);
        }

        .username-setup h2 {
            color: var(--text-accent);
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 1px 1px 2px var(--shadow-color);
        }

        .username-setup input {
            padding: 15px 20px;
            border: 3px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            margin-right: 15px;
            width: 250px;
            background: var(--bg-message);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .username-setup input:focus {
            outline: none;
            border-color: var(--text-username);
            box-shadow: 0 0 20px rgba(70, 130, 180, 0.3);
            transform: scale(1.02);
        }

        .username-setup button {
            padding: 15px 30px;
            background: var(--button-secondary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.3);
            position: relative;
            overflow: hidden;
        }

        .username-setup button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(65, 105, 225, 0.4);
        }

        .chat-interface {
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .chat-interface.active {
            display: block;
        }

        .current-user {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--text-username);
            font-size: 1.2em;
            padding: 10px;
            background: var(--bg-message);
            border-radius: 20px;
            border: 2px solid var(--border-color);
            position: relative;
        }

        .current-user::before {
            content: 'üë§';
            margin-right: 10px;
        }

        #messages {
            height: 450px;
            border: 3px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 20px;
            margin-bottom: 25px;
            font-family: inherit;
            backdrop-filter: blur(5px);
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        #messages::-webkit-scrollbar {
            width: 8px;
        }

        #messages::-webkit-scrollbar-track {
            background: transparent;
        }

        #messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }

        #messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-username);
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
            position: relative;
            animation: fadeInUp 0.4s ease-out;
            word-wrap: break-word;
            max-width: 80%;
        }

        .message:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .message.system {
            background: var(--bg-system);
            color: var(--text-system);
            font-style: italic;
            text-align: center;
            max-width: 100%;
            border: 2px dashed var(--text-system);
        }

        .message.system::before {
            content: 'üì¢ ';
        }

        .message.user {
            background: var(--bg-message);
            color: var(--text-primary);
            margin-left: 0;
            border-left: 4px solid var(--text-username);
        }

        .message.own {
            background: var(--bg-own-message);
            color: var(--text-primary);
            margin-left: auto;
            margin-right: 0;
            text-align: right;
            border-right: 4px solid var(--button-primary);
            border-left: none;
        }

        .message.own::after {
            content: ' üåü';
        }

        .message.error {
            background: var(--bg-error);
            color: var(--text-error);
            border: 2px solid var(--text-error);
            animation: shake 0.5s ease-in-out;
            max-width: 100%;
            text-align: center;
        }

        .message.file {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196F3;
        }

        .message.file.own {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-right: 4px solid #4CAF50;
            border-left: none;
        }

        .file-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--button-secondary);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            margin-top: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .file-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .file-info {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .file-preview {
            margin: 10px 0;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .preview-image:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .pdf-preview, .text-preview {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .pdf-icon, .text-icon {
            font-size: 48px;
        }

        .text-content {
            width: 100%;
            min-height: 100px;
            max-height: 300px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .text-content:focus {
            outline: 2px solid var(--button-secondary);
            outline-offset: 2px;
        }

        .preview-button {
            padding: 10px 20px;
            background: var(--button-secondary);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(65, 105, 225, 0.3);
        }

        .preview-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.4);
        }

        .username {
            font-weight: bold;
            margin-right: 10px;
            color: var(--text-username);
            text-shadow: 1px 1px 2px var(--shadow-color);
        }

        .username::before {
            content: 'üé≠ ';
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .file-button {
            padding: 18px 20px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.3);
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-button:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.4);
        }

        .file-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #messageInput {
            flex: 1;
            padding: 18px 25px;
            border: 3px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            background: var(--bg-message);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--text-username);
            box-shadow: 0 0 20px rgba(70, 130, 180, 0.3);
            transform: scale(1.02);
        }

        #messageInput:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #sendButton {
            padding: 18px 35px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.3);
            position: relative;
            overflow: hidden;
        }

        #sendButton::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--button-hover);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        #sendButton:hover::before {
            width: 300px;
            height: 300px;
        }

        #sendButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(50, 205, 50, 0.4);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #sendButton:active {
            transform: scale(0.95);
        }

        .emoji-hint {
            text-align: center;
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 0.9em;
            font-style: italic;
        }

        /* Animations pour les messages */
        @keyframes messageIn {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .message {
            animation: messageIn 0.3s ease-out;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-container {
                margin: 10px;
                padding: 20px;
                border-radius: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .username-setup input {
                width: 200px;
                margin-bottom: 15px;
            }

            .input-container {
                flex-direction: column;
            }

            #messageInput, #sendButton {
                width: 100%;
            }

            .message {
                max-width: 95%;
            }
        }

        /* Effets de particules */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--text-accent);
            border-radius: 50%;
            pointer-events: none;
            animation: particle 3s ease-out forwards;
        }

        @keyframes particle {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0) translateY(-100px);
            }
        }

        /* Modal pour cr√©er un salon */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal {
            background: var(--bg-chat);
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px var(--shadow-color);
            border: 3px solid var(--border-color);
            animation: modalSlideIn 0.4s ease-out;
            position: relative;
        }

        .modal::before {
            content: 'üè†';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 50px;
            background: var(--bg-chat);
            padding: 15px;
            border-radius: 50%;
            border: 3px solid var(--border-color);
        }

        .modal h2 {
            text-align: center;
            color: var(--text-accent);
            margin-bottom: 25px;
            margin-top: 10px;
            font-size: 1.8em;
        }

        .modal-content {
            margin-bottom: 25px;
        }

        .modal-content input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid var(--border-color);
            border-radius: 20px;
            font-size: 16px;
            background: var(--bg-message);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .modal-content input:focus {
            outline: none;
            border-color: var(--text-username);
            box-shadow: 0 0 20px rgba(70, 130, 180, 0.3);
            transform: scale(1.02);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-button {
            padding: 15px 30px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .modal-button.primary {
            background: var(--button-primary);
            color: white;
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.3);
        }

        .modal-button.secondary {
            background: var(--bg-message);
            color: var(--text-primary);
            border: 3px solid var(--border-color);
        }

        .modal-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        /* Alertes personnalis√©es */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: var(--bg-chat);
            padding: 30px;
            border-radius: 25px;
            border: 3px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            min-width: 300px;
            max-width: 500px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .custom-alert.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .custom-alert-content {
            text-align: center;
        }

        .custom-alert-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .custom-alert-message {
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .custom-alert-button {
            padding: 12px 30px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.3);
        }

        .custom-alert-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.4);
        }

        /* Checkbox style personnalis√© */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--button-primary);
        }

        .checkbox-container label {
            cursor: pointer;
            color: var(--text-primary);
            font-size: 16px;
        }

        /* Style pour les options de salon */
        .room-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-option .lock-icon {
            font-size: 14px;
        }

        /* Style am√©lior√© pour le formulaire de connexion */
        .username-form-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid var(--border-color);
            border-radius: 20px;
            font-size: 16px;
            background: var(--bg-message);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .form-group input {
            cursor: text;
            background: linear-gradient(135deg, var(--bg-message) 0%, rgba(255, 255, 255, 0.02) 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-group input:hover {
            border-color: var(--button-secondary);
            box-shadow: 0 0 15px rgba(65, 105, 225, 0.2), 0 4px 15px rgba(65, 105, 225, 0.1);
            transform: translateY(-1px);
        }
        
        .form-group input:focus {
            background: linear-gradient(135deg, var(--bg-message) 0%, rgba(65, 105, 225, 0.08) 100%);
        }
        
        .form-group select {
            cursor: pointer;
            appearance: none;
            background: linear-gradient(135deg, var(--bg-message) 0%, rgba(65, 105, 225, 0.05) 100%);
            background-image: 
                linear-gradient(135deg, var(--bg-message) 0%, rgba(65, 105, 225, 0.05) 100%),
                url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234169E1' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat, no-repeat;
            background-position: 0 0, right 15px center;
            background-size: 100% 100%, 24px;
            padding-right: 50px;
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-group select option {
            padding: 15px;
            background: var(--bg-chat);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            min-height: 45px;
            line-height: 1.5;
            border-radius: 8px;
        }

        .form-group select option:hover,
        .form-group select option:checked {
            background: linear-gradient(135deg, var(--button-secondary) 0%, rgba(65, 105, 225, 0.8) 100%);
            color: white;
            font-weight: 700;
        }

        .form-group select option:first-child {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Animation pour le select */
        .form-group select:active {
            transform: scale(0.99);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--button-secondary);
            box-shadow: 0 0 25px rgba(65, 105, 225, 0.5), 0 4px 20px rgba(65, 105, 225, 0.3);
            transform: scale(1.02);
            background: linear-gradient(135deg, var(--bg-message) 0%, rgba(65, 105, 225, 0.1) 100%);
        }
        
        .form-group select:hover {
            border-color: var(--button-secondary);
            box-shadow: 0 0 20px rgba(65, 105, 225, 0.3), 0 4px 15px rgba(65, 105, 225, 0.2);
            /* Pas de transform pour √©viter que la fl√®che danse */
        }

        .button-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-create-room {
            padding: 15px 25px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(50, 205, 50, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .btn-create-room:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.4);
        }

        .btn-create-room:disabled {
            background: rgba(128, 128, 128, 0.5);
            box-shadow: none;
            transform: none;
        }

        .btn-create-room:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .btn-join-room {
            width: 100%;
            padding: 18px 35px;
            background: var(--button-secondary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            font-family: inherit;
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.3);
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-join-room:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(65, 105, 225, 0.4);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <button class="back-button" id="backButton" title="Retour √† l'accueil">üè†</button>
        <button class="theme-toggle" id="themeToggle" title="Changer de th√®me">üåô</button>

        <h1>üèùÔ∏è Animal Chat Island üå∏</h1>

        <div id="status" class="status disconnected">
            üî¥ D√©connect√© du village
        </div>

        <!-- Interface de saisie du pseudonyme -->
        <div id="usernameSetup" class="username-setup">
            <h2 style="margin-top: 20px;">üåü Bienvenue sur l'√Æle !</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">
                Choisissez votre nom de villageois et un salon pour rejoindre la communaut√© !
            </p>
            
            <div class="username-form-row">
                <div class="form-group">
                    <label for="usernameInput">üë§ Nom de villageois</label>
                    <input type="text" id="usernameInput" placeholder="Entrez votre nom..." maxlength="20">
                </div>
                
                <div class="form-group">
                    <label for="roomSelect">üè† Salon</label>
                    <select id="roomSelect">
                        <option value="">Choisir un salon...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn-create-room" id="createRoomButton" title="Cr√©er un nouveau salon">
                        ‚ûï Cr√©er
                    </button>
                </div>
            </div>
            
            <button class="btn-join-room" id="setUsernameButton">üè° Rejoindre le salon</button>
            
            <p style="margin-top: 20px; color: var(--text-secondary); font-size: 14px;">
                üîí Vos messages, pseudos et documents sont chiffr√©s de bout en bout !
            </p>
        </div>

        <!-- Modal pour cr√©er un salon -->
        <div id="createRoomModal" class="modal-overlay">
            <div class="modal">
                <h2>Cr√©er un nouveau salon</h2>
                <div class="modal-content">
                    <input type="text" id="newRoomInput" placeholder="Nom du salon..." maxlength="30">
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="privateRoomCheckbox">
                        <label for="privateRoomCheckbox">üîí Salon priv√©</label>
                    </div>
                    
                    <div id="passwordContainer" style="display: none; margin-top: 10px;">
                        <input type="password" id="roomPasswordInput" placeholder="Mot de passe du salon..." maxlength="50">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-button primary" id="confirmCreateRoom">‚úÖ Cr√©er</button>
                    <button class="modal-button secondary" id="cancelCreateRoom">‚ùå Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal pour mot de passe salon priv√© -->
        <div id="passwordModal" class="modal-overlay">
            <div class="modal">
                <h2 style="margin-top: 2rem;">Salon priv√©</h2>
                <div class="modal-content">
                    <p style="color: var(--text-primary); margin-bottom: 15px;">
                        Ce salon est prot√©g√© par un mot de passe.
                    </p>
                    <input type="password" id="roomPasswordPrompt" placeholder="Entrez le mot de passe...">
                </div>
                <div class="modal-buttons">
                    <button class="modal-button primary" id="confirmPassword">‚úÖ Valider</button>
                    <button class="modal-button secondary" id="cancelPassword">‚ùå Annuler</button>
                </div>
            </div>
        </div>

        <!-- Interface de chat -->
        <div id="chatInterface" class="chat-interface">
            <div id="currentUser" class="current-user"></div>
            <div style="text-align: center; margin-bottom: 15px; color: var(--text-username); font-weight: bold;">
                üè† Salon: <span id="currentRoom"></span> 
                <span style="margin-left: 15px; color: var(--text-accent);">
                    üë• <span id="userCount">0</span> connect√©(s)
                </span>
            </div>

            <div id="messages"></div>

            <div class="input-container">
                <input type="file" id="fileInput" style="display: none;" accept=".png,.jpg,.jpeg,.gif,.pdf,.txt,.doc,.docx">
                <button id="fileButton" class="file-button" title="Envoyer un fichier" disabled>üìé</button>
                <input type="text" id="messageInput" placeholder="Partagez vos pens√©es avec les villageois... üí≠" disabled>
                <button id="sendButton" disabled>üì® Envoyer</button>
            </div>

            <div class="emoji-hint">
                üí° Astuce : Utilisez des emojis pour rendre vos messages plus expressifs ! üéâ
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let ws;
        let currentUsername = null;
        let currentRoom = null;
        let isAuthenticated = false;
        let encryptionKey = null; // Cl√© de chiffrement sym√©trique
        let availableRooms = [];

        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const fileButton = document.getElementById('fileButton');
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('status');
        const usernameSetup = document.getElementById('usernameSetup');
        const chatInterface = document.getElementById('chatInterface');
        const usernameInput = document.getElementById('usernameInput');
        const setUsernameButton = document.getElementById('setUsernameButton');
        const currentUserDiv = document.getElementById('currentUser');
        const currentRoomDiv = document.getElementById('currentRoom');
        const userCountDiv = document.getElementById('userCount');
        const themeToggle = document.getElementById('themeToggle');
        const backButton = document.getElementById('backButton');
        const roomSelect = document.getElementById('roomSelect');
        const createRoomButton = document.getElementById('createRoomButton');
        const createRoomModal = document.getElementById('createRoomModal');
        const newRoomInput = document.getElementById('newRoomInput');
        const confirmCreateRoom = document.getElementById('confirmCreateRoom');
        const cancelCreateRoom = document.getElementById('cancelCreateRoom');
        const privateRoomCheckbox = document.getElementById('privateRoomCheckbox');
        const passwordContainer = document.getElementById('passwordContainer');
        const roomPasswordInput = document.getElementById('roomPasswordInput');
        const passwordModal = document.getElementById('passwordModal');
        const roomPasswordPrompt = document.getElementById('roomPasswordPrompt');
        const confirmPassword = document.getElementById('confirmPassword');
        const cancelPassword = document.getElementById('cancelPassword');

        let pendingPrivateRoom = null; // Salon en attente de mot de passe

        // ========== ALERTES PERSONNALIS√âES ==========
        
        function showCustomAlert(message, icon = '‚ö†Ô∏è') {
            return new Promise((resolve) => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'custom-alert';
                alertDiv.innerHTML = `
                    <div class="custom-alert-content">
                        <div class="custom-alert-icon">${icon}</div>
                        <div class="custom-alert-message">${message}</div>
                        <button class="custom-alert-button">OK</button>
                    </div>
                `;
                
                document.body.appendChild(alertDiv);
                
                // Animation d'entr√©e
                setTimeout(() => alertDiv.classList.add('show'), 10);
                
                const button = alertDiv.querySelector('.custom-alert-button');
                button.onclick = () => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(alertDiv);
                        resolve();
                    }, 300);
                };
            });
        }

        // ========== CHIFFREMENT DE BOUT EN BOUT ==========
        
        // Hash un mot de passe avec SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + '-room-password-salt-2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // Convertir en string hexad√©cimal
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // G√©n√©rer une cl√© de chiffrement sym√©trique unique pour ce salon
        async function generateEncryptionKey(roomName) {
            // Utiliser le nom du salon comme "seed" pour la cl√©
            const encoder = new TextEncoder();
            const data = encoder.encode(roomName + '-secret-key-2024');
            
            // Cr√©er un hash SHA-256 comme cl√©
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // Importer la cl√© pour AES-GCM
            const key = await crypto.subtle.importKey(
                'raw',
                hashBuffer,
                { name: 'AES-GCM' },
                false,
                ['encrypt', 'decrypt']
            );
            
            return key;
        }

        // Chiffrer un message avec AES-GCM
        async function encryptMessage(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            // G√©n√©rer un IV (Initialization Vector) al√©atoire
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            // Chiffrer
            const encryptedData = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            
            // Convertir en base64 pour le transport
            const encryptedArray = new Uint8Array(encryptedData);
            const encryptedBase64 = btoa(String.fromCharCode(...encryptedArray));
            const ivBase64 = btoa(String.fromCharCode(...iv));
            
            return {
                encrypted: encryptedBase64,
                iv: ivBase64
            };
        }

        // D√©chiffrer un message avec AES-GCM
        async function decryptMessage(encryptedBase64, ivBase64, key) {
            try {
                // Convertir de base64
                const encryptedArray = new Uint8Array(
                    atob(encryptedBase64).split('').map(c => c.charCodeAt(0))
                );
                const iv = new Uint8Array(
                    atob(ivBase64).split('').map(c => c.charCodeAt(0))
                );
                
                // D√©chiffrer
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedArray
                );
                
                // Convertir en texte
                const decoder = new TextDecoder();
                return decoder.decode(decryptedData);
            } catch (error) {
                console.error('Erreur de d√©chiffrement:', error);
                return '[Message chiffr√© - impossible √† d√©chiffrer]';
            }
        }

        // Chiffrer un fichier (ArrayBuffer)
        async function encryptFile(arrayBuffer, key) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            const encryptedData = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                arrayBuffer
            );
            
            // Convertir en base64 sans utiliser le spread operator
            const encryptedArray = new Uint8Array(encryptedData);
            let encryptedBinary = '';
            const chunkSize = 8192;
            for (let i = 0; i < encryptedArray.length; i += chunkSize) {
                const chunk = encryptedArray.slice(i, i + chunkSize);
                encryptedBinary += String.fromCharCode.apply(null, chunk);
            }
            const encryptedBase64 = btoa(encryptedBinary);
            
            let ivBinary = '';
            for (let i = 0; i < iv.length; i += chunkSize) {
                const chunk = iv.slice(i, i + chunkSize);
                ivBinary += String.fromCharCode.apply(null, chunk);
            }
            const ivBase64 = btoa(ivBinary);
            
            return {
                encrypted: encryptedBase64,
                iv: ivBase64
            };
        }

        // D√©chiffrer un fichier
        async function decryptFile(encryptedBase64, ivBase64, key) {
            try {
                const encryptedBinary = atob(encryptedBase64);
                const encryptedArray = new Uint8Array(encryptedBinary.length);
                for (let i = 0; i < encryptedBinary.length; i++) {
                    encryptedArray[i] = encryptedBinary.charCodeAt(i);
                }
                
                const ivBinary = atob(ivBase64);
                const iv = new Uint8Array(ivBinary.length);
                for (let i = 0; i < ivBinary.length; i++) {
                    iv[i] = ivBinary.charCodeAt(i);
                }
                
                const decryptedData = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedArray
                );
                
                return decryptedData;
            } catch (error) {
                console.error('Erreur de d√©chiffrement de fichier:', error);
                return null;
            }
        }

        // ========== GESTION DES SALONS ==========
        
        // Mettre √† jour la liste d√©roulante des salons
        function updateRoomList(rooms) {
            availableRooms = rooms;
            const currentSelection = roomSelect.value;
            roomSelect.innerHTML = '<option value="">Choisir un salon...</option>';
            
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = typeof room === 'string' ? room : room.name;
                const lockIcon = (typeof room === 'object' && room.isPrivate) ? 'üîí ' : 'üè† ';
                option.textContent = `${lockIcon}${typeof room === 'string' ? room : room.name}`;
                
                // Stocker si c'est priv√© dans un attribut
                if (typeof room === 'object' && room.isPrivate) {
                    option.dataset.private = 'true';
                }
                
                roomSelect.appendChild(option);
            });
            
            // R√©selectionner le salon si possible, sinon s√©lectionner le premier
            const roomNames = rooms.map(r => typeof r === 'string' ? r : r.name);
            if (currentSelection && roomNames.includes(currentSelection)) {
                roomSelect.value = currentSelection;
            } else if (rooms.length > 0 && !isAuthenticated) {
                // S√©lectionner le premier salon par d√©faut si on n'est pas encore connect√©
                roomSelect.selectedIndex = 1;
            }
        }

        // Ouvrir la modal de cr√©ation de salon
        function openCreateRoomModal() {
            createRoomModal.classList.add('active');
            newRoomInput.value = '';
            privateRoomCheckbox.checked = false;
            roomPasswordInput.value = '';
            passwordContainer.style.display = 'none';
            newRoomInput.focus();
        }

        // Fermer la modal de cr√©ation de salon
        function closeCreateRoomModal() {
            createRoomModal.classList.remove('active');
            newRoomInput.value = '';
            privateRoomCheckbox.checked = false;
            roomPasswordInput.value = '';
            passwordContainer.style.display = 'none';
        }

        // Ouvrir la modal de mot de passe
        function openPasswordModal() {
            passwordModal.classList.add('active');
            roomPasswordPrompt.value = '';
            roomPasswordPrompt.focus();
        }

        // Fermer la modal de mot de passe
        function closePasswordModal() {
            passwordModal.classList.remove('active');
            roomPasswordPrompt.value = '';
        }

        // Soumettre le mot de passe pour rejoindre un salon priv√©
        async function submitPassword() {
            const password = roomPasswordPrompt.value.trim();
            
            if (!password) {
                await showCustomAlert('Veuillez entrer un mot de passe.', '‚ö†Ô∏è');
                return;
            }
            
            if (pendingPrivateRoom) {
                const { username, room } = pendingPrivateRoom;
                closePasswordModal();
                await joinRoom(username, room, password);
                // Ne pas r√©initialiser pendingPrivateRoom ici, on le fera apr√®s succ√®s
            }
        }

        // Cr√©er un nouveau salon
        async function createRoom() {
            const roomName = newRoomInput.value.trim();
            const isPrivate = privateRoomCheckbox.checked;
            const password = roomPasswordInput.value.trim();
            const username = usernameInput.value.trim();
            
            if (!username) {
                await showCustomAlert('Veuillez d\'abord entrer un pseudonyme.', '‚ö†Ô∏è');
                return;
            }
            
            if (!roomName) {
                await showCustomAlert('Veuillez entrer un nom de salon valide.', '‚ö†Ô∏è');
                return;
            }
            
            const roomNames = availableRooms.map(r => typeof r === 'string' ? r : r.name);
            if (roomNames.includes(roomName)) {
                await showCustomAlert('Ce salon existe d√©j√† !', '‚ö†Ô∏è');
                return;
            }
            
            if (isPrivate && !password) {
                await showCustomAlert('Veuillez entrer un mot de passe pour le salon priv√©.', 'üîí');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'createRoom',
                    roomName: roomName,
                    isPrivate: isPrivate,
                    creatorUsername: username
                };
                
                if (isPrivate) {
                    messageData.hashedPassword = await hashPassword(password);
                    // Stocker temporairement le mot de passe pour rejoindre automatiquement
                    pendingPrivateRoom = { username, room: roomName, password };
                }
                
                ws.send(JSON.stringify(messageData));
                
                // Fermer la modal
                closeCreateRoomModal();
                
                // Si public, rejoindre directement apr√®s cr√©ation
                if (!isPrivate) {
                    // Attendre que le salon soit cr√©√© et la liste mise √† jour
                    setTimeout(async () => {
                        roomSelect.value = roomName;
                        await joinRoom(username, roomName, null);
                    }, 300);
                } else {
                    // Si priv√©, rejoindre avec le mot de passe
                    setTimeout(async () => {
                        roomSelect.value = roomName;
                        await joinRoom(username, roomName, password);
                        pendingPrivateRoom = null;
                    }, 300);
                }
                
                // Afficher un message de succ√®s
                const lockIcon = isPrivate ? 'üîí' : 'üè†';
                displayMessage(`‚ú® Salon ${lockIcon} "${roomName}" cr√©√© avec succ√®s !`, 'system');
            } else {
                await showCustomAlert('Connexion au serveur perdue. Veuillez r√©essayer.', '‚ö†Ô∏è');
            }
        }

        // ========== INTERFACE UTILISATEUR ==========

        // Mode sombre
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            themeToggle.title = isDarkMode ? 'Mode clair' : 'Mode sombre';
            localStorage.setItem('darkMode', isDarkMode);

            // Effet de particules lors du changement de th√®me
            createParticles();
        }

        // Initialiser le th√®me
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
            themeToggle.title = 'Mode clair';
        }

        // Fonction pour cr√©er des particules
        function createParticles() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                    document.body.appendChild(particle);

                    setTimeout(() => {
                        particle.remove();
                    }, 3000);
                }, i * 100);
            }
        }

        // Fonction pour afficher un message dans la zone de chat
        function displayMessage(message, type = 'user', username = null, isOwnMessage = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type);

            if (isOwnMessage) {
                messageElement.classList.add('own');
            }

            if (type === 'system') {
                messageElement.textContent = message;
            } else if (type === 'error') {
                messageElement.style.backgroundColor = 'var(--bg-error)';
                messageElement.style.color = 'var(--text-error)';
                messageElement.textContent = '‚ùå ' + message;
            } else {
                const timestamp = new Date().toLocaleTimeString();
                if (username) {
                    messageElement.innerHTML = `<span class="username">${username}</span><strong>[${timestamp}]</strong> ${message}`;
                } else {
                    messageElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                }
            }

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Animation d'apparition
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
            setTimeout(() => {
                messageElement.style.transition = 'all 0.3s ease';
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 100);
        }

        // Fonction pour afficher un message avec fichier
        async function displayFileMessage(fileUrl, fileName, fileSize, fileType, username, isOwnMessage = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'file');

            if (isOwnMessage) {
                messageElement.classList.add('own');
            }

            const timestamp = new Date().toLocaleTimeString();
            const fileSizeKB = (fileSize / 1024).toFixed(2);
            
            // D√©terminer si on peut pr√©visualiser
            const isImage = fileType.startsWith('image/');
            const isPDF = fileType === 'application/pdf';
            const isText = fileType.startsWith('text/');
            
            let previewHTML = '';
            
            if (isImage) {
                // Pr√©visualisation d'image
                previewHTML = `
                    <div class="file-preview">
                        <img src="${fileUrl}" alt="${fileName}" class="preview-image" onclick="window.open('${fileUrl}', '_blank')">
                    </div>
                `;
            } else if (isPDF) {
                // Lien pour ouvrir le PDF dans un nouvel onglet
                previewHTML = `
                    <div class="file-preview pdf-preview">
                        <div class="pdf-icon">üìÑ</div>
                        <button onclick="window.open('${fileUrl}', '_blank')" class="preview-button">üîç Ouvrir le PDF</button>
                    </div>
                `;
            } else if (isText) {
                // Pr√©visualisation de texte - lire le contenu du blob
                try {
                    const response = await fetch(fileUrl);
                    const blob = await response.blob();
                    const textContent = await blob.text();
                    
                    // √âchapper les caract√®res HTML pour √©viter l'injection
                    const escapedText = textContent
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    previewHTML = `
                        <div class="file-preview text-preview">
                            <div class="text-icon">üìù</div>
                            <textarea class="text-content" readonly>${escapedText}</textarea>
                        </div>
                    `;
                } catch (e) {
                    console.error('Erreur lors de la lecture du fichier texte:', e);
                    previewHTML = `
                        <div class="file-preview text-preview">
                            <div class="text-icon">üìù</div>
                        </div>
                    `;
                }
            }
            
            messageElement.innerHTML = `
                <span class="username">${username}</span><strong>[${timestamp}]</strong><br>
                üìé Fichier: <strong>${fileName}</strong>
                <div class="file-info">Taille: ${fileSizeKB} KB</div>
                ${previewHTML}
                <a href="${fileUrl}" download="${fileName}" class="file-link">üì• T√©l√©charger</a>
            `;

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Animation d'apparition
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
            setTimeout(() => {
                messageElement.style.transition = 'all 0.3s ease';
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 100);
        }

        // Fonction pour mettre √† jour le statut de connexion
        function updateStatus(connected) {
            if (connected) {
                statusDiv.textContent = 'üü¢ Connect√© au village';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'üî¥ D√©connect√© du village';
                statusDiv.className = 'status disconnected';
                isAuthenticated = false;
                currentUsername = null;
                currentRoom = null;
                showUsernameSetup();
            }
        }

        // Fonction pour afficher l'interface de saisie du pseudonyme
        function showUsernameSetup() {
            usernameSetup.style.display = 'block';
            chatInterface.classList.remove('active');
            backButton.classList.remove('active');
            messageInput.disabled = true;
            sendButton.disabled = true;
            fileButton.disabled = true;
            usernameInput.focus();
        }

        // Fonction pour afficher l'interface de chat
        function showChatInterface() {
            usernameSetup.style.display = 'none';
            chatInterface.classList.add('active');
            backButton.classList.add('active');
            messageInput.disabled = false;
            sendButton.disabled = false;
            fileButton.disabled = false;
            currentUserDiv.textContent = `üè° Villageois: ${currentUsername}`;
            currentRoomDiv.textContent = currentRoom;
            messageInput.focus();

            // Effet de bienvenue
            createParticles();
        }

        // Fonction pour retourner √† l'accueil
        function goBackToHome() {
            // Informer le serveur qu'on quitte le salon
            if (ws && ws.readyState === WebSocket.OPEN && isAuthenticated) {
                try {
                    ws.send(JSON.stringify({
                        type: 'leave',
                        room: currentRoom
                    }));
                } catch (error) {
                    console.error('Erreur lors de la d√©connexion du salon:', error);
                }
            }
            
            // Sauvegarder le pseudo actuel
            const savedUsername = currentUsername;
            
            // R√©initialiser les variables
            isAuthenticated = false;
            currentUsername = null;
            currentRoom = null;
            encryptionKey = null;
            
            // Vider les messages
            messagesDiv.innerHTML = '';
            
            // Pr√©-remplir le champ username avec le pseudo pr√©c√©dent
            usernameInput.value = savedUsername || '';
            messageInput.value = '';
            
            // S√©lectionner le premier salon par d√©faut
            if (roomSelect.options.length > 1) {
                roomSelect.selectedIndex = 1; // S√©lectionner le premier salon (pas l'option vide)
            }
            
            // Mettre √† jour l'√©tat du bouton cr√©er
            updateCreateRoomButton();
            
            // Afficher la page d'accueil
            showUsernameSetup();
            
            displayMessage('üè† Retour √† l\'accueil', 'system');
        }

        // Fonction pour rejoindre un salon
        async function setUsername() {
            const username = usernameInput.value.trim();
            const room = roomSelect.value;

            if (username.length === 0) {
                await showCustomAlert('Veuillez saisir un pseudonyme valide.', '‚ö†Ô∏è');
                return;
            }

            if (!room) {
                await showCustomAlert('Veuillez s√©lectionner un salon.', '‚ö†Ô∏è');
                return;
            }

            // V√©rifier si le salon est priv√©
            const selectedOption = roomSelect.options[roomSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.private === 'true') {
                // Salon priv√©, demander le mot de passe
                pendingPrivateRoom = { username, room };
                openPasswordModal();
                return;
            }

            // Salon public, connexion directe
            await joinRoom(username, room, null);
        }

        // Fonction pour rejoindre effectivement un salon
        async function joinRoom(username, room, password) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    // G√©n√©rer la cl√© de chiffrement pour ce salon
                    encryptionKey = await generateEncryptionKey(room);
                    
                    // Chiffrer le username
                    const encryptedUsernameData = await encryptMessage(username, encryptionKey);
                    
                    // Cr√©er le message de bienvenue chiffr√©
                    const joinMsg = `${username} a rejoint le chat`;
                    const encryptedJoinMsg = await encryptMessage(joinMsg, encryptionKey);
                    
                    // Pr√©parer les donn√©es √† envoyer
                    const messageData = {
                        type: 'join',
                        encryptedUsername: JSON.stringify(encryptedUsernameData),
                        room: room,
                        joinMessage: JSON.stringify(encryptedJoinMsg)
                    };
                    
                    // Ajouter le mot de passe hash√© si fourni
                    if (password) {
                        messageData.hashedPassword = await hashPassword(password);
                    }
                    
                    // Envoyer au serveur
                    ws.send(JSON.stringify(messageData));
                    
                    // Sauvegarder localement (en clair)
                    currentUsername = username;
                    currentRoom = room;
                } catch (error) {
                    console.error('Erreur lors du chiffrement:', error);
                    displayMessage('Erreur lors de la connexion', 'error');
                }
            }
        }

        // ========== WEBSOCKET ==========

        // Fonction pour se connecter au serveur WebSocket
        function connectWebSocket() {
            try {
                // Connexion locale au serveur WebSocket
                ws = new WebSocket('wss://actuftour.fr/ws');

                // √âv√©nement lors de l'ouverture de la connexion
                ws.onopen = function(event) {
                    updateStatus(true);
                    displayMessage('Connexion au serveur √©tablie', 'system');
                };

                // √âv√©nement lors de la r√©ception d'un message
                ws.onmessage = async function(event) {
                    try {
                        const data = JSON.parse(event.data);

                        switch(data.type) {
                            case 'roomList':
                                updateRoomList(data.rooms);
                                // Si un salon vient d'√™tre cr√©√©, le s√©lectionner automatiquement
                                if (data.newRoom) {
                                    roomSelect.value = data.newRoom;
                                    displayMessage(`‚ú® Salon "${data.newRoom}" cr√©√© !`, 'system');
                                }
                                break;

                            case 'userCount':
                                // Mettre √† jour le nombre d'utilisateurs connect√©s
                                userCountDiv.textContent = data.count;
                                break;

                            case 'system':
                                // D√©chiffrer le message syst√®me si chiffr√©
                                if (data.encryptedMessage && encryptionKey) {
                                    const encData = JSON.parse(data.encryptedMessage);
                                    const decryptedMsg = await decryptMessage(encData.encrypted, encData.iv, encryptionKey);
                                    displayMessage('üåü ' + decryptedMsg, 'system');
                                } else {
                                    displayMessage('üåü ' + (data.message || 'Message syst√®me'), 'system');
                                }
                                break;

                            case 'userLeft':
                                // D√©chiffrer le username de l'utilisateur qui est parti
                                if (data.encryptedUsername && encryptionKey) {
                                    try {
                                        const encUsernameData = JSON.parse(data.encryptedUsername);
                                        const username = await decryptMessage(encUsernameData.encrypted, encUsernameData.iv, encryptionKey);
                                        displayMessage(`üåü ${username} a quitt√© le chat`, 'system');
                                    } catch (e) {
                                        displayMessage('üåü Un utilisateur a quitt√© le chat', 'system');
                                    }
                                }
                                break;

                            case 'error':
                                await showCustomAlert(data.message, '‚ùå');
                                
                                // Si c'est une erreur de mot de passe incorrect, rouvrir le modal
                                if (data.message.includes('Mot de passe incorrect') && pendingPrivateRoom) {
                                    openPasswordModal();
                                }
                                break;

                            case 'authenticated':
                                isAuthenticated = true;
                                pendingPrivateRoom = null; // R√©initialiser apr√®s succ√®s
                                displayMessage(`üéâ Bienvenue ${currentUsername} dans le salon ${data.room} !`, 'system');
                                showChatInterface();
                                break;

                            case 'message':
                                // D√©chiffrer le message et le username
                                if (data.encryptedMessage && data.encryptedUsername && encryptionKey) {
                                    try {
                                        const encMsgData = JSON.parse(data.encryptedMessage);
                                        const encUsernameData = JSON.parse(data.encryptedUsername);
                                        
                                        const decryptedMsg = await decryptMessage(encMsgData.encrypted, encMsgData.iv, encryptionKey);
                                        const decryptedUsername = await decryptMessage(encUsernameData.encrypted, encUsernameData.iv, encryptionKey);
                                        
                                        const isOwnMessage = decryptedUsername === currentUsername;
                                        displayMessage(decryptedMsg, 'user', decryptedUsername, isOwnMessage);

                                        // Notification pour les nouveaux messages
                                        if (!isOwnMessage) {
                                            document.title = 'üí¨ Nouveau message !';
                                            setTimeout(() => {
                                                document.title = 'üèùÔ∏è Animal Chat Island';
                                            }, 2000);
                                        }
                                    } catch (e) {
                                        console.error('Erreur de d√©chiffrement:', e);
                                        displayMessage('[Message chiffr√©]', 'user', '[Utilisateur]', false);
                                    }
                                }
                                break;

                            case 'file':
                                // D√©chiffrer et afficher le fichier
                                if (data.encryptedFile && data.encryptedUsername && encryptionKey) {
                                    try {
                                        const encFileData = JSON.parse(data.encryptedFile);
                                        const encUsernameData = JSON.parse(data.encryptedUsername);
                                        
                                        const decryptedUsername = await decryptMessage(encUsernameData.encrypted, encUsernameData.iv, encryptionKey);
                                        const decryptedFileBuffer = await decryptFile(encFileData.encrypted, encFileData.iv, encryptionKey);
                                        
                                        if (decryptedFileBuffer) {
                                            const blob = new Blob([decryptedFileBuffer], { type: data.fileType });
                                            const url = URL.createObjectURL(blob);
                                            
                                            const isOwnMessage = decryptedUsername === currentUsername;
                                            displayFileMessage(url, data.fileName, data.fileSize, data.fileType, decryptedUsername, isOwnMessage);
                                            
                                            // Notification
                                            if (!isOwnMessage) {
                                                document.title = 'üìé Nouveau fichier !';
                                                setTimeout(() => {
                                                    document.title = 'üèùÔ∏è Animal Chat Island';
                                                }, 2000);
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Erreur de d√©chiffrement du fichier:', e);
                                        displayMessage('[Fichier chiffr√© - impossible √† d√©chiffrer]', 'error');
                                    }
                                }
                                break;

                            default:
                                console.log('Message inconnu:', data);
                        }
                    } catch (error) {
                        console.error('Erreur lors du traitement du message re√ßu:', error);
                    }
                };

                // √âv√©nement lors de la fermeture de la connexion
                ws.onclose = function(event) {
                    updateStatus(false);
                    displayMessage('üåä Connexion au village ferm√©e', 'system');

                    // Tentative de reconnexion apr√®s 3 secondes
                    setTimeout(() => {
                        displayMessage('üîÑ Tentative de reconnexion au village...', 'system');
                        connectWebSocket();
                    }, 3000);
                };

                // √âv√©nement lors d'une erreur
                ws.onerror = function(error) {
                   displayMessage('‚ö†Ô∏è Erreur de connexion au village', 'system');
                };

            } catch (error) {
                console.error('Erreur lors de la cr√©ation de la connexion WebSocket:', error);
                displayMessage('Impossible de se connecter au serveur', 'system');
            }
        }

        // Fonction pour g√©rer la s√©lection de fichier
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Limite de taille : 10MB
            if (file.size > 10 * 1024 * 1024) {
                displayMessage('‚ùå Le fichier est trop volumineux (max 10MB)', 'error');
                fileInput.value = '';
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN && isAuthenticated && encryptionKey) {
                try {
                    displayMessage(`üì§ Envoi du fichier "${file.name}"...`, 'system');

                    // Lire le fichier
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // Chiffrer le fichier
                    const encryptedData = await encryptFile(arrayBuffer, encryptionKey);
                    
                    // Envoyer au serveur
                    ws.send(JSON.stringify({
                        type: 'file',
                        encryptedFile: JSON.stringify(encryptedData),
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size
                    }));
                    
                    fileInput.value = '';
                } catch (error) {
                    console.error('Erreur lors de l\'envoi du fichier:', error);
                    displayMessage('‚ùå Erreur lors de l\'envoi du fichier', 'error');
                }
            }
        }

        // Fonction pour envoyer un message
        async function sendMessage() {
            const message = messageInput.value.trim();

            if (message && ws && ws.readyState === WebSocket.OPEN && isAuthenticated && encryptionKey) {
                try {
                    // Chiffrer le message
                    const encryptedData = await encryptMessage(message, encryptionKey);
                    
                    // Envoyer au serveur
                    ws.send(JSON.stringify({
                        type: 'message',
                        encryptedMessage: JSON.stringify(encryptedData)
                    }));
                    
                    messageInput.value = '';
                    messageInput.focus();
                } catch (error) {
                    console.error('Erreur lors de l\'envoi du message:', error);
                    displayMessage('Erreur lors de l\'envoi du message', 'error');
                }
            }
        }

        // Gestionnaires d'√©v√©nements
        themeToggle.addEventListener('click', toggleTheme);
        backButton.addEventListener('click', goBackToHome);
        setUsernameButton.addEventListener('click', setUsername);
        createRoomButton.addEventListener('click', openCreateRoomModal);
        confirmCreateRoom.addEventListener('click', createRoom);
        cancelCreateRoom.addEventListener('click', closeCreateRoomModal);
        confirmPassword.addEventListener('click', submitPassword);
        cancelPassword.addEventListener('click', () => {
            closePasswordModal();
            pendingPrivateRoom = null;
        });
        sendButton.addEventListener('click', sendMessage);
        fileButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        // Afficher/masquer le champ de mot de passe selon la checkbox
        privateRoomCheckbox.addEventListener('change', function() {
            if (this.checked) {
                passwordContainer.style.display = 'block';
                roomPasswordInput.focus();
            } else {
                passwordContainer.style.display = 'none';
                roomPasswordInput.value = '';
            }
        });

        // Fermer les modals en cliquant en dehors
        createRoomModal.addEventListener('click', function(e) {
            if (e.target === createRoomModal) {
                closeCreateRoomModal();
            }
        });

        passwordModal.addEventListener('click', function(e) {
            if (e.target === passwordModal) {
                closePasswordModal();
                pendingPrivateRoom = null;
            }
        });

        // Gestionnaires d'√©v√©nements pour les touches Entr√©e
        usernameInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                setUsername();
            }
        });

        newRoomInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                createRoom();
            }
        });

        roomPasswordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                createRoom();
            }
        });

        roomPasswordPrompt.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                submitPassword();
            }
        });

        messageInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // √âchapper pour fermer les modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (createRoomModal.classList.contains('active')) {
                    closeCreateRoomModal();
                }
                if (passwordModal.classList.contains('active')) {
                    closePasswordModal();
                }
            }
        });

        // V√©rifier si on peut activer le bouton "Cr√©er un salon"
        function updateCreateRoomButton() {
            const username = usernameInput.value.trim();
            if (username.length > 0) {
                createRoomButton.disabled = false;
                createRoomButton.style.opacity = '1';
                createRoomButton.style.cursor = 'pointer';
                createRoomButton.title = 'Cr√©er un nouveau salon';
            } else {
                createRoomButton.disabled = true;
                createRoomButton.style.opacity = '0.5';
                createRoomButton.style.cursor = 'not-allowed';
                createRoomButton.title = '‚ö†Ô∏è Veuillez d\'abord entrer un pseudonyme';
            }
        }

        // √âcouter les changements dans l'input du pseudo
        usernameInput.addEventListener('input', updateCreateRoomButton);

        // D√©marrage de la connexion WebSocket au chargement de la page
        window.addEventListener('load', function() {
            displayMessage('üöÄ D√©marrage de l\'application...', 'system');
            showUsernameSetup();
            connectWebSocket();
            
            // D√©sactiver le bouton "Cr√©er" au d√©marrage
            updateCreateRoomButton();

            // Petit d√©lai pour l'animation
            setTimeout(() => {
                document.title = 'üèùÔ∏è Animal Chat Island';
            }, 1000);
        });

        // Fermeture propre de la connexion lors de la fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>